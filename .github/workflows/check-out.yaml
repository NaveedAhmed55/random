name: Attendance - Auto Check-In & Check-Out

on:
  schedule:
    # Pakistan Time = UTC + 5
    # Check-in window start: 9:00 AM PKT → 04:00 UTC
    - cron: "0 4 * * 1-5"

    # Check-out window start: 7:00 PM PKT → 14:00 UTC
    - cron: "0 14 * * 1-5"
  workflow_dispatch: {}

jobs:
  attendance:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Chromium + Chromedriver
        run: |
          sudo apt-get update -y
          sudo apt-get install -y chromium-browser chromium-chromedriver
          echo "Chromium version:"
          chromium-browser --version
          echo "Chromedriver version:"
          chromedriver --version

      - name: Determine ACTION (Checkin or Checkout)
        id: action_select
        run: |
          hour=$(date -u +"%H")

          if [ "$hour" -eq "04" ]; then
            echo "action=markCheckin" >> $GITHUB_OUTPUT
          elif [ "$hour" -eq "14" ]; then
            echo "action=markCheckout" >> $GITHUB_OUTPUT
          else
            echo "Invalid schedule hour! Exiting."
            exit 1
          fi

      - name: Run Attendance Script
        env:
          USERNAME: ${{ secrets.USERNAME }}
          PASSWORD: ${{ secrets.PASSWORD }}
          ACTION: ${{ steps.action_select.outputs.action }}
          MAX_RANDOM_DELAY: "1800"     # up to 30 minutes random delay
          HEADLESS: "true"
        run: |
          python index.py
